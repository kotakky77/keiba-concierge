<% content_for :title, "ç«¶é¦¬å¹¹äº‹ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ | #{@event.name}" %>

<div class="event-header">
  <h1><%= @event.name %></h1>
  
  <div class="event-url-box">
    <p>å…±æœ‰ç”¨URL:</p>
    <div class="url-copy-container">
      <input type="text" value="<%= event_by_hash_url(@event.url_hash) %>" id="event-url" readonly class="url-input">
      <button onclick="copyEventUrl()" class="copy-btn">ã‚³ãƒ”ãƒ¼</button>
    </div>
    <p class="help-text">ã“ã®URLã‚’å‚åŠ è€…ã«å…±æœ‰ã—ã¦ã€æ—¥ç¨‹èª¿æ•´ã‚„æŒã¡ç‰©æ‹…å½“ã®ç™»éŒ²ã‚’ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ã€‚</p>
  </div>
</div>

<div class="event-tabs">
  <button class="tab-button active" onclick="openTab(event, 'tab-basic-info')">åŸºæœ¬æƒ…å ±</button>
  <button class="tab-button" onclick="openTab(event, 'tab-schedule')">æ—¥ç¨‹èª¿æ•´</button>
  <button class="tab-button" onclick="openTab(event, 'tab-items')">æŒã¡ç‰©ãƒªã‚¹ãƒˆ</button>
  <button class="tab-button" onclick="openTab(event, 'tab-expenses')">ç²¾ç®—æƒ…å ±</button>
</div>

<!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
<div id="tab-basic-info" class="tab-content active">
  <div class="event-info-section">
    <h2>ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±</h2>
    
    <div class="info-grid">
      <div class="info-item">
        <span class="label">å ´æ‰€:</span>
        <span class="value"><%= @event.location.presence || "æœªè¨­å®š" %></span>
      </div>
      
      <div class="info-item">
        <span class="label">æ—¥æ™‚:</span>
        <span class="value">
          <% if @event.confirmed_date.present? %>
            <%= @event.confirmed_date.strftime("%Yå¹´%mæœˆ%dæ—¥ %H:%M") %>
          <% else %>
            èª¿æ•´ä¸­
          <% end %>
        </span>
      </div>
      
      <div class="info-item">
        <span class="label">çŠ¶æ…‹:</span>
        <span class="value"><%= @event.status.presence || "è¨ˆç”»ä¸­" %></span>
      </div>
    </div>
    
    <div class="memo-box">
      <h3>ãƒ¡ãƒ¢ãƒ»è£œè¶³æƒ…å ±</h3>
      <div class="memo-content">
        <% if @event.memo.present? %>
          <%= simple_format(@event.memo) %>
        <% else %>
          <p class="memo-empty">ã‚³ãƒ¡ãƒ³ãƒˆãªã—</p>
        <% end %>
      </div>
    </div>
    
    <div class="action-buttons">
      <%= link_to "ç·¨é›†ã™ã‚‹", edit_event_path(@event), class: "btn btn-secondary" %>
    </div>
  </div>
  
  <div class="participants-section">
    <h2>å‚åŠ è€…ä¸€è¦§</h2>
    
    <% if @participants.any? %>
      <div class="participants-list">
        <% @participants.each do |participant| %>
          <div class="participant-item">
            <%= participant.name %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p>ã¾ã å‚åŠ è€…ã®ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
    <% end %>
  </div>
</div>

<!-- æ—¥ç¨‹èª¿æ•´ã‚¿ãƒ– -->
<div id="tab-schedule" class="tab-content">
  <h2>æ—¥ç¨‹èª¿æ•´</h2>
  
  <% if @event.confirmed_date.present? %>
    <div class="confirmed-date-box">
      <h3>ç¢ºå®šæ—¥ç¨‹</h3>
      <div class="confirmed-date">
        <i class="fas fa-calendar-check"></i>
        <%= @event.confirmed_date.strftime("%Yå¹´%mæœˆ%dæ—¥") %>
      </div>
      <% if @event.admin_password.present? %>
        <%= form_with(url: event_path(@event), method: :patch, class: 'cancel-date-form') do |f| %>
          <%= f.hidden_field :event, value: { confirmed_date: nil } %>
          <%= f.submit 'æ—¥ç¨‹ç¢ºå®šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«', class: 'btn btn-outline-secondary btn-sm', data: { confirm: 'æ—¥ç¨‹ç¢ºå®šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ' } %>
        <% end %>
      <% end %>
    </div>
  <% end %>
  
  <!-- å€™è£œæ—¥ã¨å‚åŠ çŠ¶æ³ã®è¡¨ç¤º -->
  <% if @date_options.any? %>
    <div class="date-options-table-container">
      <h3>å€™è£œæ—¥ä¸€è¦§ã¨å‡ºæ¬ çŠ¶æ³</h3>
      
      <table class="date-options-table">
        <thead>
          <tr>
            <th>å€™è£œæ—¥</th>
            <th>å‚åŠ å¯èƒ½</th>
            <th>å¾®å¦™/æœªå®š</th>
            <th>å‚åŠ ä¸å¯</th>
            <th>æœªå›ç­”</th>
            <% if @event.confirmed_date.nil? %>
              <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @date_options.each do |date_option| %>
            <tr class="<%= 'confirmed' if @event.confirmed_date&.to_date == date_option.date %>">
              <td class="date-cell">
                <%= date_option.date.strftime("%Y/%m/%d") %>
                <% if @event.confirmed_date&.to_date == date_option.date %>
                  <span class="badge badge-success">ç¢ºå®š!</span>
                <% end %>
              </td>
              
              <% 
                yes_count = date_option.attendances.where(status: 'yes').count
                maybe_count = date_option.attendances.where(status: 'maybe').count
                no_count = date_option.attendances.where(status: 'no').count
                no_response_count = @participants.size - (yes_count + maybe_count + no_count)
              %>
              
              <td class="count-cell yes-cell">
                <div class="count-box">
                  <span class="count"><%= yes_count %></span>
                  <% if yes_count > 0 %>
                    <div class="tooltip-container">
                      <span class="tooltip-trigger"><i class="fas fa-info-circle"></i></span>
                      <div class="tooltip-content">
                        <% date_option.attendances.where(status: 'yes').includes(:participant).each do |att| %>
                          <div class="person">
                            <%= att.participant.name %>
                            <% if att.comment.present? %>
                              <div class="comment"><%= att.comment %></div>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </td>
              
              <td class="count-cell maybe-cell">
                <div class="count-box">
                  <span class="count"><%= maybe_count %></span>
                  <% if maybe_count > 0 %>
                    <div class="tooltip-container">
                      <span class="tooltip-trigger"><i class="fas fa-info-circle"></i></span>
                      <div class="tooltip-content">
                        <% date_option.attendances.where(status: 'maybe').includes(:participant).each do |att| %>
                          <div class="person">
                            <%= att.participant.name %>
                            <% if att.comment.present? %>
                              <div class="comment"><%= att.comment %></div>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </td>
              
              <td class="count-cell no-cell">
                <div class="count-box">
                  <span class="count"><%= no_count %></span>
                  <% if no_count > 0 %>
                    <div class="tooltip-container">
                      <span class="tooltip-trigger"><i class="fas fa-info-circle"></i></span>
                      <div class="tooltip-content">
                        <% date_option.attendances.where(status: 'no').includes(:participant).each do |att| %>
                          <div class="person">
                            <%= att.participant.name %>
                            <% if att.comment.present? %>
                              <div class="comment"><%= att.comment %></div>
                            <% end %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </td>
              
              <td class="count-cell no-response-cell">
                <span class="count"><%= no_response_count %></span>
              </td>
              
              <% if @event.confirmed_date.nil? %>
                <td class="action-cell">
                  <%= button_to 'æ—¥ç¨‹ã‚’ç¢ºå®š', event_path(@event), method: :patch, 
                      params: { event: { confirmed_date: date_option.date } }, 
                      class: 'btn btn-sm btn-success' %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
      
      <div class="detailed-status-view">
        <h3>å‚åŠ è€…åˆ¥å‡ºæ¬ çŠ¶æ³</h3>
        <table class="attendance-details-table">
          <thead>
            <tr>
              <th>å‚åŠ è€…</th>
              <% @date_options.each do |date_option| %>
                <th><%= date_option.date.strftime("%-m/%-d") %></th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @participants.each do |participant| %>
              <tr>
                <td class="participant-name"><%= participant.name %></td>
                <% @date_options.each do |date_option| %>
                  <% attendance = Attendance.find_by(participant: participant, date_option: date_option) %>
                  <td class="attendance-status-cell">
                    <% if attendance %>
                      <span class="status-<%= attendance.status %>">
                        <%= { 'yes' => 'â—¯', 'maybe' => 'â–³', 'no' => 'âœ•' }[attendance.status] %>
                      </span>
                      <% if attendance.comment.present? %>
                        <div class="tooltip-container">
                          <span class="comment-icon">ğŸ’¬</span>
                          <div class="tooltip-content">
                            <div class="comment"><%= attendance.comment %></div>
                          </div>
                        </div>
                      <% end %>
                    <% else %>
                      <span class="status-none">-</span>
                    <% end %>
                  </td>
                <% end %>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% else %>
    <div class="no-options-message">
      <p>å€™è£œæ—¥ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€™è£œæ—¥ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
      
      <!-- å€™è£œæ—¥è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="date-option-form">
        <h3>å€™è£œæ—¥ã®è¿½åŠ </h3>
        <%= form_with(model: @new_date_option, url: event_date_options_path(@event), local: true) do |f| %>
          <div class="form-group">
            <%= f.label :date, 'å€™è£œæ—¥' %>
            <%= f.date_field :date, required: true, class: 'form-control' %>
          </div>
          <%= f.submit 'å€™è£œæ—¥ã‚’è¿½åŠ ', class: 'btn btn-primary' %>
        <% end %>
      </div>
    </div>
  <% end %>
  
  <!-- å‡ºæ¬ å›ç­”ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="attendance-form">
    <h3>å‡ºæ¬ ã‚’å›ç­”ã™ã‚‹</h3>
    
    <% if @date_options.any? %>
      <!-- æ–°è¦å‚åŠ è€…ç”¨ãƒ•ã‚©ãƒ¼ãƒ  -->
      <%= form_with(url: event_participants_path(@event), local: true, class: 'response-form') do |f| %>
        <div class="form-group">
          <%= f.label :name, 'ãŠåå‰' %>
          <%= f.text_field :name, required: true, class: 'form-control' %>
        </div>
        
        <div class="form-group">
          <%= f.label :comment, 'å…¨ä½“ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰' %>
          <%= f.text_area :comment, class: 'form-control', rows: 2 %>
        </div>
        
        <div class="date-responses">
          <h4>å„å€™è£œæ—¥ã¸ã®å›ç­”</h4>
          
          <% @date_options.each do |date_option| %>
            <div class="date-response-item">
              <p class="date-label"><%= date_option.date.strftime("%Yå¹´%mæœˆ%dæ—¥") %></p>
              
              <div class="response-options">
                <%= f.radio_button "attendance_form[date_option_ids][#{date_option.id}]", 'yes', id: "yes_#{date_option.id}", required: true %>
                <%= f.label "yes_#{date_option.id}", 'â—‹ å‚åŠ å¯èƒ½', class: 'radio-label yes-label' %>
                
                <%= f.radio_button "attendance_form[date_option_ids][#{date_option.id}]", 'maybe', id: "maybe_#{date_option.id}" %>
                <%= f.label "maybe_#{date_option.id}", 'â–³ å¾®å¦™/æœªå®š', class: 'radio-label maybe-label' %>
                
                <%= f.radio_button "attendance_form[date_option_ids][#{date_option.id}]", 'no', id: "no_#{date_option.id}" %>
                <%= f.label "no_#{date_option.id}", 'Ã— å‚åŠ ä¸å¯', class: 'radio-label no-label' %>
              </div>
              
              <div class="date-comment-field">
                <%= f.text_field "attendance_form[date_option_comments][#{date_option.id}]", placeholder: 'ã“ã®æ—¥ç¨‹ã«ã¤ã„ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰', class: 'form-control date-comment-input' %>
              </div>
            </div>
          <% end %>
        </div>
        
        <%= f.submit 'å›ç­”ã‚’é€ä¿¡', class: 'btn btn-primary' %>
      <% end %>
      
      <!-- æ—¢å­˜å‚åŠ è€…ç”¨ã®å›ç­”æ›´æ–°ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="existing-participant-form">
        <h3>æ—¢å­˜ã®å›ç­”ã‚’æ›´æ–°ã™ã‚‹</h3>
        
        <% if @participants.any? %>
          <div class="select-participant-form">
            <label for="participant-selector">å‚åŠ è€…ã‚’é¸æŠ</label>
            <select id="participant-selector" class="form-control">
              <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
              <% @participants.each do |participant| %>
                <option value="<%= participant.id %>"><%= participant.name %></option>
              <% end %>
            </select>
            <button onclick="showUpdateForm()" class="btn btn-secondary mt-2">é¸æŠ</button>
          </div>
          
          <div id="update-attendance-form" style="display: none;">
            <%= form_with(url: update_attendance_event_participants_path(@event), method: :post, local: true, class: 'update-response-form') do |f| %>
              <%= f.hidden_field :participant_id, id: 'selected-participant-id' %>
              
              <div class="form-group">
                <label>å‚åŠ è€…å: <span id="selected-participant-name"></span></label>
              </div>
              
              <div class="form-group">
                <%= f.label :comment, 'å…¨ä½“ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰' %>
                <%= f.text_area :comment, class: 'form-control', rows: 2, id: 'update-comment' %>
              </div>
              
              <div class="date-responses" id="update-date-responses">
                <h4>å„å€™è£œæ—¥ã¸ã®å›ç­”</h4>
                
                <% @date_options.each do |date_option| %>
                  <div class="date-response-item" id="update-response-<%= date_option.id %>">
                    <p class="date-label"><%= date_option.date.strftime("%Yå¹´%mæœˆ%dæ—¥") %></p>
                    
                    <div class="response-options">
                      <%= f.radio_button "attendance_form[date_option_ids][#{date_option.id}]", 'yes', id: "update_yes_#{date_option.id}" %>
                      <%= f.label "update_yes_#{date_option.id}", 'â—‹ å‚åŠ å¯èƒ½', class: 'radio-label yes-label' %>
                      
                      <%= f.radio_button "attendance_form[date_option_ids][#{date_option.id}]", 'maybe', id: "update_maybe_#{date_option.id}" %>
                      <%= f.label "update_maybe_#{date_option.id}", 'â–³ å¾®å¦™/æœªå®š', class: 'radio-label maybe-label' %>
                      
                      <%= f.radio_button "attendance_form[date_option_ids][#{date_option.id}]", 'no', id: "update_no_#{date_option.id}" %>
                      <%= f.label "update_no_#{date_option.id}", 'Ã— å‚åŠ ä¸å¯', class: 'radio-label no-label' %>
                    </div>
                    
                    <div class="date-comment-field">
                      <%= f.text_field "attendance_form[date_option_comments][#{date_option.id}]", 
                          placeholder: 'ã“ã®æ—¥ç¨‹ã«ã¤ã„ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰', 
                          class: 'form-control date-comment-input',
                          id: "update_comment_#{date_option.id}" %>
                    </div>
                  </div>
                <% end %>
              </div>
              
              <%= f.submit 'å›ç­”ã‚’æ›´æ–°', class: 'btn btn-primary' %>
            <% end %>
          </div>
        <% else %>
          <p>ã¾ã å‚åŠ è€…ãŒã„ã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æœ€åˆã®å›ç­”ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚</p>
        <% end %>
      </div>
      
      <script>
        // å‚åŠ è€…ã®éå»ã®å›ç­”ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
        function showUpdateForm() {
          const participantId = document.getElementById('participant-selector').value;
          if (!participantId) return;
          
          document.getElementById('selected-participant-id').value = participantId;
          
          // é¸æŠã•ã‚ŒãŸå‚åŠ è€…ã®åå‰ã‚’è¡¨ç¤º
          const participantSelect = document.getElementById('participant-selector');
          const selectedOption = participantSelect.options[participantSelect.selectedIndex];
          document.getElementById('selected-participant-name').textContent = selectedOption.text;
          
          // éå»ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹AJAXãƒªã‚¯ã‚¨ã‚¹ãƒˆ
          fetch(`/events/<%= @event.id %>/participants/${participantId}/attendances`)
            .then(response => response.json())
            .then(data => {
              // å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
              document.getElementById('update-attendance-form').style.display = 'block';
              
              // å…¨ä½“ã‚³ãƒ¡ãƒ³ãƒˆã¯ãªã„ã®ã§åˆæœŸåŒ–
              document.getElementById('update-comment').value = '';
              
              // å„å€™è£œæ—¥ã®å›ç­”çŠ¶æ…‹ã‚’è¨­å®š
              if (data.attendances) {
                data.attendances.forEach(attendance => {
                  // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’é¸æŠ
                  const radioId = `update_${attendance.status}_${attendance.date_option_id}`;
                  const radio = document.getElementById(radioId);
                  if (radio) radio.checked = true;
                  
                  // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’è¨­å®š
                  const commentField = document.getElementById(`update_comment_${attendance.date_option_id}`);
                  if (commentField && attendance.comment) {
                    commentField.value = attendance.comment;
                  }
                });
              }
            })
            .catch(error => {
              console.error('å›ç­”ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
              alert('éå»ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }
      </script>
    <% else %>
      <p>å€™è£œæ—¥ãŒç™»éŒ²ã•ã‚Œã‚‹ã¨ã€ã“ã“ã«å‡ºæ¬ å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    <% end %>
  </div>
</div>

<!-- æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚¿ãƒ– -->
<div id="tab-items" class="tab-content">
  <h2>æŒã¡ç‰©ãƒªã‚¹ãƒˆ</h2>
  
  <!-- æŒã¡ç‰©è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="item-form">
    <h3>æŒã¡ç‰©ã®è¿½åŠ </h3>
    <%= form_with(model: @new_item, url: event_items_path(@event), local: true) do |f| %>
      <div class="form-row">
        <div class="form-group">
          <%= f.label :name, 'å“ç›®' %>
          <%= f.text_field :name, required: true, class: 'form-control' %>
        </div>
        
        <div class="form-group">
          <%= f.label :quantity, 'æ•°é‡' %>
          <%= f.number_field :quantity, min: 1, value: 1, class: 'form-control quantity-input' %>
        </div>
        
        <%= f.submit 'è¿½åŠ ', class: 'btn btn-primary' %>
      </div>
    <% end %>
  </div>
  
  <!-- æŒã¡ç‰©ãƒªã‚¹ãƒˆ -->
  <% if @items.any? %>
    <div class="items-table-container">
      <h3>æŒã¡ç‰©ä¸€è¦§</h3>
      
      <table class="items-table">
        <thead>
          <tr>
            <th>å“ç›®</th>
            <th>æ•°é‡</th>
            <th>æ‹…å½“è€…</th>
            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
          </tr>
        </thead>
        <tbody>
          <% @items.each do |item| %>
            <tr>
              <td><%= item.name %></td>
              <td><%= item.quantity %></td>
              <td>
                <% if item.participant %>
                  <%= item.participant.name %>
                <% else %>
                  <span class="not-assigned">æœªå‰²å½“</span>
                <% end %>
              </td>
              <td class="action-cell">
                <% if item.participant.nil? %>
                  <div class="assign-form">
                    <%= form_with(url: event_item_path(@event, item), method: :patch, local: true) do |f| %>
                      <% if @participants.any? %>
                        <%= f.select :participant_id, @participants.map { |p| [p.name, p.id] }, { include_blank: 'æ‹…å½“è€…ã‚’é¸æŠ' }, class: 'form-select' %>
                        <%= f.submit 'æ‹…å½“ã™ã‚‹', class: 'btn btn-sm btn-secondary' %>
                      <% else %>
                        <span class="help-text">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</span>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <%= button_to 'æ‹…å½“è§£é™¤', event_item_path(@event, item), method: :patch, params: { participant_id: nil }, class: 'btn btn-sm btn-outline' %>
                <% end %>
                <%= button_to 'å‰Šé™¤', event_item_path(@event, item), method: :delete, class: 'btn btn-sm btn-danger', data: { confirm: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' } %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="no-items-message">
      <p>æŒã¡ç‰©ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æŒã¡ç‰©ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
  <% end %>
</div>

<!-- ç²¾ç®—æƒ…å ±ã‚¿ãƒ– -->
<div id="tab-expenses" class="tab-content">
  <h2>ç²¾ç®—æƒ…å ±</h2>
  
  <!-- è²»ç”¨è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="expense-form">
    <h3>è²»ç”¨ã®ç™»éŒ²</h3>
    <%= form_with(model: @new_expense, url: event_expenses_path(@event), local: true) do |f| %>
      <div class="form-row">
        <div class="form-group">
          <%= f.label :name, 'é …ç›®' %>
          <%= f.text_field :name, required: true, placeholder: 'ä¾‹: å…¥å ´æ–™', class: 'form-control' %>
        </div>
        
        <div class="form-group">
          <%= f.label :amount, 'é‡‘é¡ (å††)' %>
          <%= f.number_field :amount, min: 1, required: true, class: 'form-control' %>
        </div>
        
        <div class="form-group">
          <%= f.label :payer_id, 'æ”¯æ‰•è€…' %>
          <%= f.collection_select :payer_id, @participants, :id, :name, { prompt: 'é¸æŠã—ã¦ãã ã•ã„' }, { required: true, class: 'form-select' } %>
        </div>
        
        <%= f.submit 'ç™»éŒ²', class: 'btn btn-primary' %>
      </div>
    <% end %>
  </div>
  
  <!-- è²»ç”¨ä¸€è¦§ -->
  <% if @expenses.any? %>
    <div class="expenses-table-container">
      <h3>è²»ç”¨ä¸€è¦§</h3>
      
      <table class="expenses-table">
        <thead>
          <tr>
            <th>é …ç›®</th>
            <th>é‡‘é¡</th>
            <th>æ”¯æ‰•è€…</th>
            <th>çŠ¶æ…‹</th>
            <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
          </tr>
        </thead>
        <tbody>
          <% @expenses.each do |expense| %>
            <tr>
              <td><%= expense.name %></td>
              <td class="amount-cell"><%= number_with_delimiter(expense.amount) %>å††</td>
              <td><%= expense.payer.name %></td>
              <td>
                <% if expense.paid_status %>
                  <span class="status-paid">ç²¾ç®—æ¸ˆã¿</span>
                <% else %>
                  <span class="status-unpaid">æœªç²¾ç®—</span>
                <% end %>
              </td>
              <td class="action-cell">
                <% if expense.paid_status %>
                  <%= button_to 'æœªç²¾ç®—ã«æˆ»ã™', event_expense_path(@event, expense), method: :patch, params: { expense: { paid_status: false } }, class: 'btn btn-sm btn-outline' %>
                <% else %>
                  <%= button_to 'ç²¾ç®—æ¸ˆã¿ã«ã™ã‚‹', event_expense_path(@event, expense), method: :patch, params: { expense: { paid_status: true } }, class: 'btn btn-sm btn-success' %>
                <% end %>
                <%= button_to 'å‰Šé™¤', event_expense_path(@event, expense), method: :delete, class: 'btn btn-sm btn-danger', data: { confirm: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' } %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      
      <!-- ç²¾ç®—ã‚µãƒãƒªãƒ¼ -->
      <div class="expense-summary">
        <h4>ç²¾ç®—ã‚µãƒãƒªãƒ¼</h4>
        
        <div class="summary-box">
          <div class="summary-item">
            <span class="label">åˆè¨ˆé‡‘é¡:</span>
            <span class="value"><%= number_with_delimiter(@expenses.sum(&:amount)) %>å††</span>
          </div>
          
          <div class="summary-item">
            <span class="label">å‚åŠ è€…ä¸€äººã‚ãŸã‚Š:</span>
            <span class="value">
              <% if @participants.any? %>
                <%= number_with_delimiter((@expenses.sum(&:amount) / @participants.size.to_f).ceil) %>å††
              <% else %>
                0å††
              <% end %>
            </span>
          </div>
          
          <div class="participants-payment">
            <h5>å‚åŠ è€…ã”ã¨ã®æ”¯æ‰•ã„/å—ã‘å–ã‚Šé¡</h5>
            
            <% if @participants.any? %>
              <div class="payment-list">
                <% per_person = (@expenses.sum(&:amount) / @participants.size.to_f).ceil %>
                
                <% @participants.each do |participant| %>
                  <% paid_amount = @expenses.select { |e| e.payer_id == participant.id }.sum(&:amount) %>
                  <% balance = paid_amount - per_person %>
                  
                  <div class="payment-item">
                    <span class="name"><%= participant.name %></span>
                    <span class="paid-amount">æ”¯æ‰•æ¸ˆã¿: <%= number_with_delimiter(paid_amount) %>å††</span>
                    
                    <span class="balance <%= balance >= 0 ? 'positive' : 'negative' %>">
                      <% if balance > 0 %>
                        å—ã‘å–ã‚Š: <%= number_with_delimiter(balance.abs) %>å††
                      <% elsif balance < 0 %>
                        æ”¯æ‰•ã„: <%= number_with_delimiter(balance.abs) %>å††
                      <% else %>
                        ç²¾ç®—ä¸è¦
                      <% end %>
                    </span>
                  </div>
                <% end %>
              </div>
            <% else %>
              <p>å‚åŠ è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="no-expenses-message">
      <p>è²»ç”¨æƒ…å ±ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è²»ç”¨ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
  <% end %>
</div>

<style>
  /* ã‚¤ãƒ™ãƒ³ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ */
  .event-header {
    margin-bottom: 30px;
  }
  
  .event-url-box {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-top: 15px;
  }
  
  .url-copy-container {
    display: flex;
    margin: 10px 0;
  }
  
  .url-input {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ced4da;
    border-radius: 4px 0 0 4px;
    background-color: #f1f3f5;
  }
  
  .copy-btn {
    padding: 8px 15px;
    background-color: #4a6eb5;
    color: white;
    border: none;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
  }
  
  .help-text {
    color: #6c757d;
    font-size: 14px;
    margin: 5px 0;
  }
  
  /* ã‚¿ãƒ– */
  .event-tabs {
    display: flex;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 20px;
    overflow-x: auto;
  }
  
  .tab-button {
    padding: 10px 20px;
    background-color: transparent;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-weight: bold;
    color: #6c757d;
    transition: all 0.3s;
  }
  
  .tab-button:hover {
    color: #4a6eb5;
  }
  
  .tab-button.active {
    color: #4a6eb5;
    border-bottom-color: #4a6eb5;
  }
  
  .tab-content {
    display: none;
    padding: 20px 0;
  }
  
  .tab-content.active {
    display: block;
  }
  
  /* åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .event-info-section, .participants-section {
    margin-bottom: 30px;
  }
  
  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  
  .info-item {
    display: flex;
    flex-direction: column;
  }
  
  .label {
    font-weight: bold;
    color: #6c757d;
    margin-bottom: 5px;
  }
  
  .value {
    font-size: 18px;
  }
  
  .memo-box {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin: 20px 0;
  }
  
  .participants-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 15px;
  }
  
  .participant-item {
    background-color: #e9ecef;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 14px;
  }
  
  /* æ—¥ç¨‹èª¿æ•´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .date-option-form, .date-options-table-container, .attendance-form {
    margin-bottom: 30px;
  }
  
  .date-options-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    margin-bottom: 30px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .date-options-table tr.confirmed {
    background-color: #e8f4fc;
  }
  
  .date-options-table th, .date-options-table td {
    border: 1px solid #dee2e6;
    padding: 10px;
    text-align: center;
  }
  
  .date-options-table th {
    background-color: #f8f9fa;
  }
  
  .date-cell {
    white-space: nowrap;
    font-weight: bold;
  }
  
  .attendance-cell {
    font-size: 18px;
  }
  
  .status-yes {
    color: #28a745;
    font-weight: bold;
  }
  
  .status-maybe {
    color: #ffc107;
    font-weight: bold;
  }
  
  .status-no {
    color: #dc3545;
    font-weight: bold;
  }
  
  .comment-icon {
    margin-left: 3px;
    cursor: help;
  }
  
  .action-cell {
    white-space: nowrap;
  }
  
  .date-response-item {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    border-left: 3px solid #4a6eb5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .date-label {
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .response-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .radio-label {
    margin-right: 10px;
    cursor: pointer;
  }
  
  .yes-label {
    color: #28a745;
  }
  
  .maybe-label {
    color: #ffc107;
  }
  
  .no-label {
    color: #dc3545;
  }
  
  .confirmed-date-box {
    background-color: #e8f4fc;
    border-left: 4px solid #4a6eb5;
    padding: 15px;
    margin-bottom: 30px;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .confirmed-date {
    font-size: 24px;
    font-weight: bold;
    color: #4a6eb5;
    margin: 10px 0;
  }
  
  .confirmed-date i {
    margin-right: 10px;
  }
  
  .cancel-date-form {
    margin-top: 10px;
  }
  
  .count-cell {
    text-align: center;
    position: relative;
    width: 80px;
  }
  
  .count-box {
    position: relative;
    display: inline-block;
  }
  
  .count {
    font-size: 18px;
    font-weight: bold;
    display: inline-block;
    min-width: 30px;
  }
  
  .yes-cell .count {
    color: #28a745;
  }
  
  .maybe-cell .count {
    color: #ffc107;
  }
  
  .no-cell .count {
    color: #dc3545;
  }
  
  .no-response-cell .count {
    color: #6c757d;
  }
  
  .tooltip-container {
    position: relative;
    display: inline-block;
  }
  
  .tooltip-trigger {
    cursor: pointer;
    color: #6c757d;
    margin-left: 5px;
  }
  
  .tooltip-content {
    display: none;
    position: absolute;
    z-index: 100;
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    min-width: 200px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    left: 50%;
    transform: translateX(-50%);
    top: 100%;
    margin-top: 5px;
  }
  
  .tooltip-container:hover .tooltip-content {
    display: block;
  }
  
  .person {
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
  }
  
  .person:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }
  
  .comment {
    font-size: 12px;
    color: #6c757d;
    margin-top: 3px;
    font-style: italic;
  }
  
  .detailed-status-view {
    margin-top: 30px;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
  }
  
  .attendance-details-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    background-color: white;
  }
  
  .attendance-details-table th, .attendance-details-table td {
    border: 1px solid #dee2e6;
    padding: 8px;
    text-align: center;
  }
  
  .attendance-details-table th {
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);
  }
  
  .participant-name {
    font-weight: bold;
    text-align: left;
    position: sticky;
    left: 0;
    background-color: white;
    box-shadow: 2px 0 2px -1px rgba(0,0,0,0.1);
  }
  
  .attendance-status-cell {
    position: relative;
  }
  
  .attendance-status-cell .status-yes {
    color: #28a745;
    font-weight: bold;
    font-size: 18px;
  }
  
  .attendance-status-cell .status-maybe {
    color: #ffc107;
    font-weight: bold;
    font-size: 18px;
  }
  
  .attendance-status-cell .status-no {
    color: #dc3545;
    font-weight: bold;
    font-size: 18px;
  }
  
  .attendance-status-cell .status-none {
    color: #adb5bd;
  }
  
  .attendance-status-cell .comment-icon {
    font-size: 12px;
    margin-left: 3px;
    cursor: help;
  }
  
  .date-comment-field {
    margin-top: 10px;
  }
  
  .date-comment-input {
    font-size: 14px;
  }
  
  .existing-participant-form {
    margin-top: 40px;
    border-top: 1px dashed #dee2e6;
    padding-top: 30px;
  }
  
  .select-participant-form {
    margin-bottom: 20px;
  }
  
  .update-response-form {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 3px solid #6c757d;
  }
  
  .badge {
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 75%;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
  }
  
  .badge-success {
    color: #fff;
    background-color: #28a745;
  }
  
  .mt-2 {
    margin-top: 0.5rem;
  }
  
  @media (max-width: 768px) {
    .date-options-table, .attendance-details-table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }
    
    .detailed-status-view {
      padding: 10px;
    }
    
    .count-cell {
      width: 60px;
    }
  }
  
  /* æŒã¡ç‰©ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .item-form, .items-table-container {
    margin-bottom: 30px;
  }
  
  .form-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
    flex-wrap: wrap;
  }
  
  .quantity-input {
    width: 80px;
  }
  
  .items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  .items-table th, .items-table td {
    border: 1px solid #dee2e6;
    padding: 10px;
  }
  
  .items-table th {
    background-color: #f8f9fa;
  }
  
  .not-assigned {
    color: #6c757d;
    font-style: italic;
  }
  
  .form-select {
    padding: 5px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    margin-right: 5px;
  }
  
  /* ç²¾ç®—æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .expense-form, .expenses-table-container {
    margin-bottom: 30px;
  }
  
  .expenses-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  .expenses-table th, .expenses-table td {
    border: 1px solid #dee2e6;
    padding: 10px;
  }
  
  .expenses-table th {
    background-color: #f8f9fa;
  }
  
  .amount-cell {
    text-align: right;
    font-weight: bold;
  }
  
  .status-paid {
    color: #28a745;
    font-weight: bold;
  }
  
  .status-unpaid {
    color: #dc3545;
    font-weight: bold;
  }
  
  .expense-summary {
    margin-top: 30px;
  }
  
  .summary-box {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
  }
  
  .summary-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 18px;
  }
  
  .participants-payment {
    margin-top: 20px.
  }
  
  .payment-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .payment-item {
    padding: 10px;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 5px;
  }
  
  .payment-item .name {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .payment-item .paid-amount {
    display: block;
    margin-bottom: 5px.
  }
  
  .payment-item .balance {
    display: block;
    font-weight: bold.
  }
  
  .balance.positive {
    color: #28a745.
  }
  
  .balance.negative {
    color: #dc3545.
  }
  
  /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
  .btn {
    display: inline-block;
    font-weight: 400;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 0.25rem;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out.
  }
  
  .btn-primary {
    color: #fff;
    background-color: #4a6eb5;
    border-color: #4a6eb5.
  }
  
  .btn-secondary {
    color: #fff;
    background-color: #6c757d;
    border-color: #6c757d.
  }
  
  .btn-success {
    color: #fff;
    background-color: #28a745;
    border-color: #28a745.
  }
  
  .btn-danger {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545.
  }
  
  .btn-outline {
    color: #6c757d;
    background-color: transparent;
    border-color: #6c757d.
  }
  
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.5;
    border-radius: 0.2rem.
  }
  
  .form-group {
    margin-bottom: 1rem.
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem.
  }
  
  .form-control {
    display: block;
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out.
  }
  
  .form-control:focus {
    color: #495057;
    background-color: #fff;
    border-color: #8bb8f4;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(74, 110, 181, 0.25).
  }
  
  .action-buttons {
    margin-top: 20px.
  }
  
  @media (max-width: 768px) {
    .form-row {
      flex-direction: column.
    }
    
    .event-tabs {
      overflow-x: auto.
    }
  }
</style>

<script>
  function openTab(evt, tabId) {
    // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    var tabcontents = document.getElementsByClassName("tab-content");
    for (var i = 0; i < tabcontents.length; i++) {
      tabcontents[i].classList.remove("active");
    }
    
    // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    var tablinks = document.getElementsByClassName("tab-button");
    for (var i = 0; i < tablinks.length; i++) {
      tablinks[i].classList.remove("active");
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
    document.getElementById(tabId).classList.add("active");
    evt.currentTarget.classList.add("active");
  }
  
  function copyEventUrl() {
    var copyText = document.getElementById("event-url");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");
    
    // ã‚³ãƒ”ãƒ¼æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    alert("URLãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼");
  }
  
  // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®å‹•ä½œã‚’æ”¹å–„ã™ã‚‹JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipContainers = document.querySelectorAll('.tooltip-container');
    
    tooltipContainers.forEach(function(container) {
      var trigger = container.querySelector('.tooltip-trigger');
      var content = container.querySelector('.tooltip-content');
      
      if (trigger && content) {
        trigger.addEventListener('mouseenter', function() {
          content.style.display = 'block';
        });
        
        trigger.addEventListener('mouseleave', function() {
          content.style.display = 'none';
        });
      }
    });
  });
</script>
